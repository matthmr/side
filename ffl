#!/usr/bin/env bash
# Integrated by mH (https://github.com/matthmr)

#*****************************************************
# change anything that is followed by "#change this" #
#*****************************************************

# ffl [pager/editor] -l [1,2,3] -n [unit name]

logdir='' # change this
VERSION="v0.2.1"

function usage {
	printf "Usage: ffl [pager] -l [1..3] -n [name]. See ffl --help\n"
	exit 1
}

function toggle_l {
	if $get_l; then
		l=${all[2]}
		get_l=false
	elif $get_n; then
		n=${all[2]}
		get_n=false
	else usage; fi
}

function toggle_n {
	if $get_n; then
		n=${all[4]}
		get_n=false
	elif $get_l; then
		l=${all[4]}
		get_l=false
	else usage; fi
}

case $1 in
	'--help'|'-h') printf "\nIntegrated by mH (https://github.com/matthmr)
		ffl\t\t\t => fuzzy finds log files generated by unit\n
Integration:    fzf\t\t\t => made by junegunn (https://github.com/junegunn/fzf)
		unit\t\t\t => made by mH (https://github.com/matthmr/side/unit)\n
Usage:\t\tffl [pager]      \t => Defaults to '-l 3'
		ffl [pager] -l [1..3]    => Change the level of the date search; 1 is %%d, 2 is %%m-%%d, 3 is %%Y-%%m-%%d
		ffl [pager] -n [name]  \t => Fuzzy names, unit-style\n
Info:\t\tffl [--help/-h]\t\t => Displays this message and exit
		ffl [--version/-v]\t => Displays version and exits\n
Note:\t\tAt the moment, this is NOT scriptsd compliant, the directory is hard-coded at \`logdir\`
		\n"
		exit 0
		;;
	'--version'|'-v') printf "ffl $VERSION\n"
		exit 0
		;;
esac

get_l=false
get_n=false

all=($@)
len=${#all[@]}

(( "$len" > 5 )) && usage

for (( i = 0 ; i < len ; i++ )); do
	case $i in
		'0') view=${all[$i]} ;;
		'1'|'3') \
		case ${all[$i]} in
			'-l') ! $get_l && get_l=true || usage;;
			'-n') ! $get_n && get_n=true || usage;;
			*) usage;;
		esac;;
		'2') toggle_l ;;
		'4') toggle_n ;;
	esac
done

[[ ! "$view" ]] && usage

function run {

	if [ -z "$l" ];  then

		if [ -z "$n" ]; then
			date=$(date +%Y-%m-%d)
			filename="$logdir/$(ls -1 $logdir | grep $date | fzf)"
		fi
		if [ -n "$n" ]; then
			filename="$logdir/$(ls -1 $logdir | grep $n | fzf)"
		fi

	else

		case $l in
			'1') str='date +%Y';;
			'2') str='date +%Y-%m';;
			'3') str='date +%Y-%m-%d';;
			*)   usage
		esac

		if [ -z "$n" ]; then
			filename="$logdir/$(ls -1 $logdir | grep $(exec $str) | fzf)"
		fi
		if [ -n "$n" ]; then
			filename="$logdir/$(ls -1 $logdir | grep $(exec $str) | grep $n | fzf)"
		fi

	fi

	$view $filename
}

run
